<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω v√† Thi Tr·∫Øc Nghi·ªám</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      background-image: url('https://images.unsplash.com/photo-1512820790803-83ca734da794?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .question-card, .folder-card {
      transition: transform 0.2s ease;
    }
    .question-card:hover, .folder-card:hover {
      transform: scale(1.02);
    }
    #progressBar {
      transition: width 0.3s ease;
    }
    #countdown {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="min-h-screen p-4">
  <div id="progressBarContainer" class="hidden fixed top-0 left-0 w-full h-2 bg-gray-200">
    <div id="progressBar" class="h-full bg-amber-500" style="width: 0%"></div>
  </div>
  <div id="countdown" class="hidden fixed top-4 right-4 bg-red-600 text-white font-bold text-lg px-4 py-2 rounded-xl shadow-lg">00:30</div>
  <div class="max-w-5xl mx-auto bg-white/90 backdrop-blur-md shadow-lg rounded-xl p-6">
    <h1 class="text-3xl font-bold text-center text-amber-800 mb-6" style="font-family: 'Montserrat', sans-serif;">
      üìö Qu·∫£n l√Ω v√† Thi Tr·∫Øc Nghi·ªám
    </h1>

    <!-- Tabs -->
    <div class="flex mb-4 rounded-xl overflow-hidden border border-amber-300">
      <button id="folderTab" class="flex-1 py-2 text-center font-medium transition-colors duration-300 bg-gray-100 text-gray-700 hover:bg-gray-200">
        üìÅ Qu·∫£n l√Ω Th∆∞ M·ª•c
      </button>
      <button id="manageTab" class="flex-1 py-2 text-center font-medium transition-colors duration-300 bg-amber-600 text-white hover:bg-amber-700">
        Qu·∫£n l√Ω C√¢u H·ªèi
      </button>
      <button id="quizTab" class="flex-1 py-2 text-center font-medium transition-colors duration-300 bg-gray-100 text-gray-700 hover:bg-gray-200">
        Ch·∫ø ƒë·ªô Thi
      </button>
    </div>

    <!-- Qu·∫£n l√Ω Th∆∞ M·ª•c -->
    <div id="folderSection" class="hidden">
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-amber-600 mb-2">üìÅ Qu·∫£n l√Ω Th∆∞ M·ª•c</h2>
        <div class="flex gap-2 mb-4">
          <input id="newFolderName" type="text" placeholder="T√™n th∆∞ m·ª•c m·ªõi"
            class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white" />
          <button onclick="addFolder()" class="bg-amber-600 text-white hover:bg-amber-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
            ‚ûï T·∫°o Th∆∞ M·ª•c
          </button>
        </div>
        <div id="folderList" class="space-y-4"></div>
      </div>
    </div>

    <!-- Qu·∫£n l√Ω C√¢u H·ªèi -->
    <div id="manageSection" class="block">
      <div class="mb-6">
        <div class="flex items-center gap-4 mb-4">
          <h2 class="text-lg font-semibold text-amber-600">üìù Th√™m C√¢u H·ªèi</h2>
          <select id="currentFolder" class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white">
            <option value="">Ch·ªçn th∆∞ m·ª•c</option>
          </select>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <input id="question" type="text" placeholder="N·ªôi dung c√¢u h·ªèi (h·ªó tr·ª£ LaTeX, v√≠ d·ª•: \\(x^2 + 2x + 1 = 0\\))"
            class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white" />
          <div class="grid grid-cols-2 gap-4">
            <input id="option1" type="text" placeholder="ƒê√°p √°n 1"
              class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white" />
            <input id="option2" type="text" placeholder="ƒê√°p √°n 2"
              class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white" />
            <input id="option3" type="text" placeholder="ƒê√°p √°n 3"
              class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white" />
            <input id="option4" type="text" placeholder="ƒê√°p √°n 4"
              class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white" />
          </div>
          <select id="correctOption" class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white">
            <option value="">Ch·ªçn ƒë√°p √°n ƒë√∫ng</option>
            <option value="1">ƒê√°p √°n 1</option>
            <option value="2">ƒê√°p √°n 2</option>
            <option value="3">ƒê√°p √°n 3</option>
            <option value="4">ƒê√°p √°n 4</option>
          </select>
          <select id="difficulty" class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white">
            <option value="easy">D·ªÖ</option>
            <option value="medium">Trung b√¨nh</option>
            <option value="hard">Kh√≥</option>
          </select>
          <textarea id="explanation" placeholder="Gi·∫£i th√≠ch ƒë√°p √°n (h·ªó tr·ª£ LaTeX)"
            class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all h-24 bg-white"></textarea>
        </div>
        <div class="flex gap-2 mt-4">
          <button onclick="addQuestion()" class="bg-amber-600 text-white hover:bg-amber-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
            ‚ûï L∆∞u C√¢u H·ªèi
          </button>
          <button onclick="exportQuestions()" class="bg-teal-600 text-white hover:bg-teal-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
            ‚¨áÔ∏è Xu·∫•t JSON
          </button>
          <input type="file" id="importFile" class="hidden" onchange="importQuestions(event)" />
          <button onclick="document.getElementById('importFile').click()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
            ‚¨ÜÔ∏è Nh·∫≠p JSON
          </button>
        </div>
      </div>
      <div id="questionList" class="space-y-4"></div>
    </div>

    <!-- Ch·∫ø ƒë·ªô Thi -->
    <div id="quizSection" class="hidden">
      <div id="quizArea" class="mb-6">
        <div id="quizStart" class="flex items-center gap-4 mb-4">
          <h2 class="text-lg font-semibold text-amber-600">üéØ Ch·∫ø ƒë·ªô Thi</h2>
          <select id="quizFolder" class="border border-gray-300 focus:ring-2 focus:ring-amber-500 focus:outline-none rounded-xl px-3 py-2 shadow-sm transition-all bg-white">
            <option value="">Ch·ªçn th∆∞ m·ª•c ƒë·ªÉ thi</option>
          </select>
          <button onclick="startQuiz()" class="bg-amber-600 text-white hover:bg-amber-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
            ‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu Thi
          </button>
        </div>
        <div id="quizContent" class="hidden">
          <div class="flex flex-col md:flex-row gap-4">
            <!-- Question Content (Left, 60-70%) -->
            <div class="w-full md:w-3/5 bg-white/90 backdrop-blur-md rounded-xl shadow-lg p-4">
              <div id="quizQuestion" class="font-bold mb-4 text-base text-gray-800"></div>
              <div id="quizOptions" class="space-y-2"></div>
              <div id="quizFeedback" class="mt-4 hidden"></div>
              <div class="flex flex-wrap gap-2 mt-4">
                <button id="prevQuestion" onclick="prevQuestion()" class="bg-gray-600 text-white hover:bg-gray-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95 hidden">
                  ‚¨ÖÔ∏è C√¢u Tr∆∞·ªõc
                </button>
                <button id="submitAnswer" onclick="submitAnswer()" class="bg-amber-600 text-white hover:bg-amber-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95 hidden">
                  N·ªôp ƒê√°p √Ån
                </button>
                <button id="retryQuestion" onclick="retryQuestion()" class="border border-gray-500 text-gray-700 hover:bg-gray-200 text-sm px-3 py-1 rounded-xl shadow-md transition-all duration-200 active:scale-95 hidden">
                  ‚ôªÔ∏è L√†m l·∫°i c√¢u n√†y
                </button>
                <button id="nextQuestion" onclick="nextQuestion()" class="bg-teal-600 text-white hover:bg-teal-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95 hidden">
                  C√¢u Ti·∫øp Theo
                </button>
                <button id="restartQuiz" onclick="restartQuiz()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95 hidden">
                  L√†m L·∫°i
                </button>
                <button id="returnToStart" onclick="returnToQuizStart()" class="bg-gray-600 text-white hover:bg-gray-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95 hidden">
                  üîô Tr·ªü L·∫°i
                </button>
              </div>
            </div>
            <!-- Question Map (Right, 30-40%) -->
            <div class="w-full md:w-2/5 bg-white/90 backdrop-blur-md rounded-xl shadow-lg p-4">
              <h3 class="text-lg font-semibold text-amber-600 mb-4">üó∫Ô∏è B·∫£n ƒë·ªì c√¢u h·ªèi</h3>
              <div id="questionMapGrid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-4 lg:grid-cols-5 gap-2"></div>
            </div>
          </div>
        </div>
      </div>
      <canvas id="mathCanvas" class="hidden" width="400" height="100"></canvas>
    </div>

    <script>
      let folders = JSON.parse(localStorage.getItem("folders")) || [];
      let currentFolderId = null;
      let currentQuestionIndex = 0;
      let userAnswers = [];
      let selectedAnswer = null;
      let incorrectAnswersHistory = [];
      let quizTimer = null;
      const canvas = document.getElementById("mathCanvas");
      const ctx = canvas.getContext("2d");

      // Tab switching
      function switchTab(tabId) {
        const sections = ["folderSection", "manageSection", "quizSection"];
        const tabs = ["folderTab", "manageTab", "quizTab"];
        sections.forEach(section => document.getElementById(section).classList.add("hidden"));
        tabs.forEach(tab => {
          document.getElementById(tab).classList.add("bg-gray-100", "text-gray-700");
          document.getElementById(tab).classList.remove("bg-amber-600", "text-white");
        });
        document.getElementById(`${tabId}Section`).classList.remove("hidden");
        document.getElementById(`${tabId}Tab`).classList.add("bg-amber-600", "text-white");
        document.getElementById(`${tabId}Tab`).classList.remove("bg-gray-100", "text-gray-700");
        document.getElementById("progressBarContainer").classList.add("hidden");
        document.getElementById("countdown").classList.add("hidden");
        clearInterval(quizTimer);
        if (tabId === "folder") renderFolders();
        if (tabId === "manage") {
          renderFolderSelect();
          renderQuestions();
        }
        if (tabId === "quiz") {
          renderQuizFolderSelect();
          resetQuizInterface();
        }
      }

      document.getElementById("folderTab").addEventListener("click", () => switchTab("folder"));
      document.getElementById("manageTab").addEventListener("click", () => switchTab("manage"));
      document.getElementById("quizTab").addEventListener("click", () => switchTab("quiz"));

      // Math rendering
      function renderMath() {
        MathJax.typesetPromise();
      }

      function drawMathExpression(expression, x, y) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "20px Arial";
        ctx.fillText(math.parse(expression).toString(), x, y);
      }

      // Render Question Map
      function renderQuestionMap() {
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder ? folder.questions.filter(q => isValidForQuiz(q).isValid) : [];
        const mapGrid = document.getElementById("questionMapGrid");
        mapGrid.innerHTML = '';
        validQuestions.forEach((q, index) => {
          const status = userAnswers[index] === null ? 'unanswered' : userAnswers[index] === q.correctOption ? 'correct' : 'incorrect';
          const bgColor = index === currentQuestionIndex ? 'bg-blue-600' : status === 'correct' ? 'bg-green-500' : status === 'incorrect' ? 'bg-red-500' : 'bg-gray-200';
          const button = document.createElement('button');
          button.className = `w-8 h-8 flex items-center justify-center rounded-md text-white font-medium text-sm transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 ${bgColor}`;
          button.textContent = index + 1;
          button.title = `C√¢u ${index + 1}: ${status === 'unanswered' ? 'Ch∆∞a tr·∫£ l·ªùi' : status === 'correct' ? 'ƒê√∫ng' : 'Sai'}`;
          button.addEventListener('click', () => goToQuestion(index));
          mapGrid.appendChild(button);
        });
      }

      // Navigate to a specific question
      function goToQuestion(index) {
        selectedAnswer = userAnswers[index];
        currentQuestionIndex = index;
        displayQuestion();
      }

      // Retry Question
      function retryQuestion() {
        userAnswers[currentQuestionIndex] = null;
        selectedAnswer = null;
        displayQuestion();
      }

      // Qu·∫£n l√Ω Th∆∞ M·ª•c
      function renderFolders() {
        const folderList = document.getElementById("folderList");
        folderList.innerHTML = "";
        folders.forEach(folder => {
          const div = document.createElement("div");
          div.className = "folder-card bg-white shadow-lg rounded-xl p-4 border border-gray-200 flex items-center justify-between";
          div.innerHTML = `
            <span class="text-base font-semibold text-gray-800">${folder.name}</span>
            <div class="flex gap-2">
              <button onclick="openFolder('${folder.id}')" class="bg-amber-600 text-white hover:bg-amber-700 px-3 py-1 rounded-xl shadow-md transition-all duration-200 active:scale-95">üìÇ M·ªü</button>
              <button onclick="renameFolder('${folder.id}')" class="bg-yellow-600 text-white hover:bg-yellow-700 px-3 py-1 rounded-xl shadow-md transition-all duration-200 active:scale-95">‚úèÔ∏è ƒê·ªïi t√™n</button>
              <button onclick="deleteFolder('${folder.id}')" class="bg-red-600 text-white hover:bg-red-700 px-3 py-1 rounded-xl shadow-md transition-all duration-200 active:scale-95">üóëÔ∏è X√≥a</button>
            </div>
          `;
          folderList.appendChild(div);
        });
        localStorage.setItem("folders", JSON.stringify(folders));
      }

      function addFolder() {
        const name = document.getElementById("newFolderName").value.trim();
        if (!name) {
          alert("Vui l√≤ng nh·∫≠p t√™n th∆∞ m·ª•c.");
          return;
        }
        const id = crypto.randomUUID();
        folders.push({ id, name, questions: [] });
        document.getElementById("newFolderName").value = "";
        renderFolders();
      }

      function renameFolder(folderId) {
        const newName = prompt("Nh·∫≠p t√™n m·ªõi cho th∆∞ m·ª•c:");
        if (newName && newName.trim()) {
          const folder = folders.find(f => f.id === folderId);
          if (folder) {
            folder.name = newName.trim();
            renderFolders();
          }
        }
      }

      function deleteFolder(folderId) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th∆∞ m·ª•c n√†y v√† t·∫•t c·∫£ c√¢u h·ªèi trong ƒë√≥?")) {
          folders = folders.filter(f => f.id !== folderId);
          if (currentFolderId === folderId) currentFolderId = null;
          renderFolders();
          renderFolderSelect();
          renderQuizFolderSelect();
        }
      }

      function openFolder(folderId) {
        currentFolderId = folderId;
        switchTab("manage");
      }

      function renderFolderSelect() {
        const select = document.getElementById("currentFolder");
        select.innerHTML = '<option value="">Ch·ªçn th∆∞ m·ª•c</option>';
        folders.forEach(folder => {
          const option = document.createElement("option");
          option.value = folder.id;
          option.textContent = folder.name;
          if (folder.id === currentFolderId) option.selected = true;
          select.appendChild(option);
        });
      }

      function renderQuizFolderSelect() {
        const select = document.getElementById("quizFolder");
        select.innerHTML = '<option value="">Ch·ªçn th∆∞ m·ª•c ƒë·ªÉ thi</option>';
        folders.forEach(folder => {
          const option = document.createElement("option");
          option.value = folder.id;
          option.textContent = folder.name;
          select.appendChild(option);
        });
      }

      // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa c√¢u h·ªèi cho ch·∫ø ƒë·ªô thi
      function isValidForQuiz(q) {
        const hasQuestionContent = q.question.trim().length > 0;
        const hasFourOptions = q.options.length === 4 && q.options.every(opt => opt.trim().length > 0);
        const hasCorrectOption = q.correctOption && ["1", "2", "3", "4"].includes(q.correctOption);
        return {
          isValid: hasQuestionContent && hasFourOptions && hasCorrectOption,
          reasons: [
            !hasQuestionContent ? "Thi·∫øu n·ªôi dung c√¢u h·ªèi" : "",
            !hasFourOptions ? "C·∫ßn ƒë·ªß 4 ƒë√°p √°n kh√¥ng r·ªóng" : "",
            !hasCorrectOption ? "Thi·∫øu ho·∫∑c ƒë√°p √°n ƒë√∫ng kh√¥ng h·ª£p l·ªá" : ""
          ].filter(reason => reason)
        };
      }

      // Qu·∫£n l√Ω C√¢u H·ªèi
      function renderQuestions() {
        if (!currentFolderId) {
          document.getElementById("questionList").innerHTML = "<p class='text-gray-600'>Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c ƒë·ªÉ qu·∫£n l√Ω c√¢u h·ªèi.</p>";
          return;
        }
        const folder = folders.find(f => f.id === currentFolderId);
        const questionList = document.getElementById("questionList");
        questionList.innerHTML = "";
        folder.questions.forEach((q, index) => {
          const { isValid, reasons } = isValidForQuiz(q);
          const div = document.createElement("div");
          div.className = "question-card bg-white shadow-lg rounded-xl p-4 border border-gray-200";
          div.innerHTML = `
            <div class="text-base font-bold text-gray-800 mb-2">${index + 1}. ${q.question || "(Ch∆∞a c√≥ n·ªôi dung)"} <span class="text-sm ${isValid ? 'text-green-600' : 'text-red-500'}">(${isValid ? 'H·ª£p l·ªá cho thi' : 'Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán thi: ' + reasons.join(", ")})</span> <span class="text-sm text-amber-600">[${q.difficulty === 'easy' ? 'D·ªÖ' : q.difficulty === 'medium' ? 'Trung b√¨nh' : 'Kh√≥'}]</span></div>
            <ul class="space-y-1 ml-4 text-sm">
              ${q.options[0] ? `<li class="${q.correctOption === "1" ? 'text-green-600 font-semibold' : 'text-gray-700'}">${q.options[0]}</li>` : ""}
              ${q.options[1] ? `<li class="${q.correctOption === "2" ? 'text-green-600 font-semibold' : 'text-gray-700'}">${q.options[1]}</li>` : ""}
              ${q.options[2] ? `<li class="${q.correctOption === "3" ? 'text-green-600 font-semibold' : 'text-gray-700'}">${q.options[2]}</li>` : ""}
              ${q.options[3] ? `<li class="${q.correctOption === "4" ? 'text-green-600 font-semibold' : 'text-gray-700'}">${q.options[3]}</li>` : ""}
              ${!q.options[0] && !q.options[1] && !q.options[2] && !q.options[3] ? "<li class='text-gray-700'>(Ch∆∞a c√≥ ƒë√°p √°n)</li>" : ""}
            </ul>
            ${q.explanation ? `<div class="mt-2 text-sm text-gray-600"><strong>Gi·∫£i th√≠ch:</strong> ${q.explanation}</div>` : "<div class='mt-2 text-sm text-gray-600'>(Ch∆∞a c√≥ gi·∫£i th√≠ch)</div>"}
            <div class="flex gap-2 mt-3">
              <button onclick="editQuestion(${index})" class="bg-yellow-600 text-white hover:bg-yellow-700 px-3 py-1 rounded-xl shadow-md transition-all duration-200 active:scale-95">‚úèÔ∏è S·ª≠a</button>
              <button onclick="deleteQuestion(${index})" class="bg-red-600 text-white hover:bg-red-700 px-3 py-1 rounded-xl shadow-md transition-all duration-200 active:scale-95">üóëÔ∏è X√≥a</button>
            </div>
          `;
          questionList.appendChild(div);
        });
        renderMath();
        localStorage.setItem("folders", JSON.stringify(folders));
      }

      function addQuestion() {
        if (!currentFolderId) {
          alert("Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c tr∆∞·ªõc khi th√™m c√¢u h·ªèi.");
          return;
        }
        const question = document.getElementById("question").value.trim();
        const option1 = document.getElementById("option1").value.trim();
        const option2 = document.getElementById("option2").value.trim();
        const option3 = document.getElementById("option3").value.trim();
        const option4 = document.getElementById("option4").value.trim();
        const correctOption = document.getElementById("correctOption").value;
        const difficulty = document.getElementById("difficulty").value;
        const explanation = document.getElementById("explanation").value.trim();

        if (!question && !option1 && !option2 && !option3 && !option4 && !explanation) {
          alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt tr∆∞·ªùng (c√¢u h·ªèi, ƒë√°p √°n ho·∫∑c gi·∫£i th√≠ch).");
          return;
        }

        const options = [];
        if (option1) options.push(option1);
        if (option2) options.push(option2);
        if (option3) options.push(option3);
        if (option4) options.push(option4);

        if (correctOption && options.length < parseInt(correctOption)) {
          alert("ƒê√°p √°n ƒë√∫ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn ƒë√°p √°n ƒë√∫ng ph√π h·ª£p v·ªõi c√°c ƒë√°p √°n ƒë√£ nh·∫≠p.");
          return;
        }

        const newQuestion = {
          question: question || "",
          options,
          correctOption: correctOption || "",
          difficulty: difficulty || "easy",
          explanation: explanation || "",
        };

        const folder = folders.find(f => f.id === currentFolderId);
        folder.questions.push(newQuestion);
        clearForm();
        renderQuestions();
      }

      function clearForm() {
        document.getElementById("question").value = "";
        document.getElementById("option1").value = "";
        document.getElementById("option2").value = "";
        document.getElementById("option3").value = "";
        document.getElementById("option4").value = "";
        document.getElementById("correctOption").value = "";
        document.getElementById("difficulty").value = "easy";
        document.getElementById("explanation").value = "";
      }

      function editQuestion(index) {
        const folder = folders.find(f => f.id === currentFolderId);
        const q = folder.questions[index];
        document.getElementById("question").value = q.question;
        document.getElementById("option1").value = q.options[0] || "";
        document.getElementById("option2").value = q.options[1] || "";
        document.getElementById("option3").value = q.options[2] || "";
        document.getElementById("option4").value = q.options[3] || "";
        document.getElementById("correctOption").value = q.correctOption || "";
        document.getElementById("difficulty").value = q.difficulty;
        document.getElementById("explanation").value = q.explanation;
        folder.questions.splice(index, 1);
        renderQuestions();
      }

      function deleteQuestion(index) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?")) {
          const folder = folders.find(f => f.id === currentFolderId);
          folder.questions.splice(index, 1);
          renderQuestions();
        }
      }

      function exportQuestions() {
        if (!currentFolderId) {
          alert("Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c ƒë·ªÉ xu·∫•t c√¢u h·ªèi.");
          return;
        }
        const folder = folders.find(f => f.id === currentFolderId);
        const blob = new Blob([JSON.stringify(folder.questions, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${folder.name}_questions.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function importQuestions(event) {
        if (!currentFolderId) {
          alert("Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c ƒë·ªÉ nh·∫≠p c√¢u h·ªèi.");
          return;
        }
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
              alert("File JSON ph·∫£i l√† m·ªôt m·∫£ng c√°c c√¢u h·ªèi.");
              return;
            }
            const validQuestions = imported.filter(q => 
              q.question !== undefined && 
              q.options && Array.isArray(q.options) && 
              q.correctOption !== undefined && 
              q.explanation !== undefined &&
              ["easy", "medium", "hard"].includes(q.difficulty)
            );
            const folder = folders.find(f => f.id === currentFolderId);
            folder.questions = folder.questions.concat(validQuestions);
            alert(`ƒê√£ nh·∫≠p ${validQuestions.length} c√¢u h·ªèi m·ªõi.`);
            renderQuestions();
          } catch (err) {
            alert("L·ªói ƒë·ªçc file JSON: " + err.message);
          }
        };
        reader.readAsText(file);
      }

      // Ch·∫ø ƒë·ªô Thi
      function resetQuizInterface() {
        document.getElementById("quizStart").classList.remove("hidden");
        document.getElementById("quizContent").classList.add("hidden");
        document.getElementById("quizFolder").value = "";
        currentFolderId = null;
        userAnswers = [];
        selectedAnswer = null;
        incorrectAnswersHistory = [];
        currentQuestionIndex = 0;
        clearInterval(quizTimer);
        document.getElementById("progressBarContainer").classList.add("hidden");
        document.getElementById("countdown").classList.add("hidden");
      }

      function returnToQuizStart() {
        resetQuizInterface();
        renderQuizFolderSelect();
      }

      function startQuiz(resetAnswers = true) {
        const folderId = document.getElementById("quizFolder").value;
        if (!folderId) {
          alert("Vui l√≤ng ch·ªçn m·ªôt th∆∞ m·ª•c ƒë·ªÉ b·∫Øt ƒë·∫ßu thi.");
          return;
        }
        currentFolderId = folderId;
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder.questions.filter(q => isValidForQuiz(q).isValid);
        if (validQuestions.length === 0) {
          document.getElementById("quizArea").innerHTML = "<p class='text-red-500 font-semibold'>Ch∆∞a c√≥ c√¢u h·ªèi h·ª£p l·ªá n√†o trong th∆∞ m·ª•c n√†y. C·∫ßn c√¢u h·ªèi c√≥ n·ªôi dung, ƒë·ªß 4 ƒë√°p √°n kh√¥ng r·ªóng, v√† ƒë√°p √°n ƒë√∫ng ƒë∆∞·ª£c ch·ªçn.</p>";
          return;
        }
        currentQuestionIndex = 0;
        if (resetAnswers) {
          userAnswers = new Array(validQuestions.length).fill(null);
          incorrectAnswersHistory = [];
        }
        selectedAnswer = userAnswers[0];
        document.getElementById("quizStart").classList.add("hidden");
        document.getElementById("quizContent").classList.remove("hidden");
        document.getElementById("submitAnswer").classList.remove("hidden");
        document.getElementById("nextQuestion").classList.add("hidden");
        document.getElementById("prevQuestion").classList.add("hidden");
        document.getElementById("restartQuiz").classList.add("hidden");
        document.getElementById("returnToStart").classList.add("hidden");
        document.getElementById("retryQuestion").classList.add("hidden");
        document.getElementById("progressBarContainer").classList.remove("hidden");
        document.getElementById("countdown").classList.remove("hidden");
        startTimer();
        updateProgressBar();
        displayQuestion();
        renderQuestionMap();
      }

      function restartQuiz() {
        incorrectAnswersHistory = [];
        startQuiz(true);
      }

      function startTimer() {
        let timeLeft = 30;
        document.getElementById("countdown").textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
        quizTimer = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 0) {
            clearInterval(quizTimer);
            submitAnswer();
          }
          document.getElementById("countdown").textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
        }, 1000);
      }

      function updateProgressBar() {
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder.questions.filter(q => isValidForQuiz(q).isValid);
        const progress = ((currentQuestionIndex + 1) / validQuestions.length) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
      }

      function displayQuestion() {
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder.questions.filter(q => isValidForQuiz(q).isValid);
        const q = validQuestions[currentQuestionIndex];
        document.getElementById("quizQuestion").innerHTML = `${currentQuestionIndex + 1}. ${q.question} <span class="text-sm text-amber-600">[${q.difficulty === 'easy' ? 'D·ªÖ' : q.difficulty === 'medium' ? 'Trung b√¨nh' : 'Kh√≥'}]</span>`;
        const optionsDiv = document.getElementById("quizOptions");
        optionsDiv.innerHTML = "";
        q.options.forEach((option, i) => {
          const value = `${i + 1}`;
          const isSelected = selectedAnswer === value;
          const isSubmitted = userAnswers[currentQuestionIndex] !== null;
          optionsDiv.innerHTML += `
            <div class="flex items-center">
              <div
                class="w-full p-2 border border-gray-300 rounded-md text-gray-700 cursor-pointer transition-all duration-200 hover:bg-amber-100 ${isSelected ? 'bg-amber-200 border-amber-500' : ''} ${isSubmitted ? 'pointer-events-none opacity-50' : ''}"
                onclick="selectAnswer('${value}')"
              >
                ${option}
              </div>
            </div>
          `;
        });
        document.getElementById("quizFeedback").classList.toggle("hidden", userAnswers[currentQuestionIndex] === null);
        document.getElementById("prevQuestion").classList.toggle("hidden", currentQuestionIndex === 0);
        document.getElementById("nextQuestion").classList.toggle("hidden", currentQuestionIndex >= validQuestions.length - 1 || userAnswers[currentQuestionIndex] === null);
        document.getElementById("submitAnswer").classList.toggle("hidden", userAnswers[currentQuestionIndex] !== null || selectedAnswer === null);
        document.getElementById("retryQuestion").classList.toggle("hidden", userAnswers[currentQuestionIndex] === null);
        clearInterval(quizTimer);
        startTimer();
        updateProgressBar();
        renderQuestionMap();
        renderMath();
      }

      function selectAnswer(value) {
        if (userAnswers[currentQuestionIndex] !== null) return; // Prevent selection if submitted
        if (selectedAnswer === value) {
          selectedAnswer = null; // Deselect if already selected
        } else {
          selectedAnswer = value; // Select new answer
        }
        displayQuestion();
      }

      function submitAnswer() {
        if (selectedAnswer === null) {
          alert("Vui l√≤ng ch·ªçn m·ªôt ƒë√°p √°n.");
          return;
        }
        const answer = selectedAnswer;
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder.questions.filter(q => isValidForQuiz(q).isValid);
        const q = validQuestions[currentQuestionIndex];
        userAnswers[currentQuestionIndex] = answer;
        selectedAnswer = null;
        const feedbackDiv = document.getElementById("quizFeedback");
        feedbackDiv.classList.remove("hidden");
        feedbackDiv.classList.add("fade-in");
        if (answer === q.correctOption) {
          feedbackDiv.innerHTML = `
            <p class="text-lg font-semibold mb-2 text-green-600">‚úÖ Ch√≠nh x√°c!</p>
            <p class="bg-green-100 text-green-800 p-2 rounded mb-4">
              <strong>Gi·∫£i th√≠ch:</strong> ${q.explanation || "(Kh√¥ng c√≥ gi·∫£i th√≠ch)"}
            </p>
          `;
        } else {
          feedbackDiv.innerHTML = `
            <p class="text-lg font-semibold mb-2 text-red-600">‚ùå Sai!</p>
            <p class="bg-red-100 text-red-800 p-2 rounded mb-4">
              <strong>ƒê√°p √°n ƒë√∫ng:</strong> ${q.options[parseInt(q.correctOption) - 1]}<br>
              <strong>Gi·∫£i th√≠ch:</strong> ${q.explanation || "(Kh√¥ng c√≥ gi·∫£i th√≠ch)"}
            </p>
          `;
        }
        document.getElementById("submitAnswer").classList.add("hidden");
        document.getElementById("retryQuestion").classList.remove("hidden");
        document.getElementById("nextQuestion").classList.remove("hidden");
        clearInterval(quizTimer);
        renderQuestionMap();
        renderMath();
      }

      function prevQuestion() {
        if (currentQuestionIndex > 0) {
          selectedAnswer = userAnswers[currentQuestionIndex - 1];
          currentQuestionIndex--;
          displayQuestion();
        }
      }

      function nextQuestion() {
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder.questions.filter(q => isValidForQuiz(q).isValid);
        if (currentQuestionIndex < validQuestions.length - 1) {
          selectedAnswer = userAnswers[currentQuestionIndex + 1];
          currentQuestionIndex++;
          displayQuestion();
        } else {
          showResults();
        }
      }

      function showResults() {
        const folder = folders.find(f => f.id === currentFolderId);
        const validQuestions = folder.questions.filter(q => isValidForQuiz(q).isValid);
        let correctCount = 0;
        incorrectAnswersHistory = [];
        validQuestions.forEach((q, i) => {
          if (userAnswers[i] === q.correctOption) {
            correctCount++;
          } else if (userAnswers[i] !== null) {
            incorrectAnswersHistory.push({
              questionNumber: i + 1,
              question: q.question,
              userAnswer: q.options[parseInt(userAnswers[i]) - 1],
              correctAnswer: q.options[parseInt(q.correctOption) - 1],
              explanation: q.explanation || "(Kh√¥ng c√≥ gi·∫£i th√≠ch)"
            });
          }
        });
        const incorrectCount = incorrectAnswersHistory.length;
        let incorrectAnswersHTML = '';
        if (incorrectAnswersHistory.length > 0) {
          incorrectAnswersHTML = `
            <h3 class="text-lg font-semibold text-red-600 mt-6 mb-4">üìù Xem l·∫°i c√°c c√¢u sai</h3>
            <div class="space-y-4 max-h-96 overflow-y-auto">
              ${incorrectAnswersHistory.map(item => `
                <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                  <p class="font-bold text-gray-800">C√¢u ${item.questionNumber}: ${item.question}</p>
                  <p class="text-sm text-red-600 mt-1"><strong>ƒê√°p √°n b·∫°n ch·ªçn:</strong> ${item.userAnswer}</p>
                  <p class="text-sm text-green-600 mt-1"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${item.correctAnswer}</p>
                  <p class="text-sm text-gray-600 mt-1"><strong>Gi·∫£i th√≠ch:</strong> ${item.explanation}</p>
                </div>
              `).join('')}
            </div>
          `;
        } else {
          incorrectAnswersHTML = `
            <h3 class="text-lg font-semibold text-green-600 mt-6 mb-4">üéâ Kh√¥ng c√≥ c√¢u sai!</h3>
            <p class="text-gray-600">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£ c√°c c√¢u h·ªèi.</p>
          `;
        }
        document.getElementById("quizContent").innerHTML = `
          <div class="fade-in">
            <h2 class="text-lg font-semibold text-amber-600 mb-2">üèÜ K·∫øt Qu·∫£</h2>
            <p class="text-base text-gray-800">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng <span class="font-bold text-green-600">${correctCount}</span>/${validQuestions.length} c√¢u h·ªèi.</p>
            <p class="text-base text-gray-800">S·ªë c√¢u sai: <span class="font-bold text-red-600">${incorrectCount}</span></p>
            <p class="text-base text-gray-800">T·ª∑ l·ªá ƒë√∫ng: <span class="font-bold text-green-600">${(correctCount / validQuestions.length * 100).toFixed(2)}%</span></p>
            <div class="flex gap-2 mt-4">
              <button id="restartQuiz" onclick="restartQuiz()" class="bg-indigo-600 text-white hover:bg-indigo-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
                L√†m L·∫°i
              </button>
              <button id="returnToStart" onclick="returnToQuizStart()" class="bg-gray-600 text-white hover:bg-gray-700 px-4 py-2 rounded-xl shadow-md transition-all duration-200 active:scale-95">
                üîô Tr·ªü L·∫°i
              </button>
            </div>
            ${incorrectAnswersHTML}
          </div>
        `;
        document.getElementById("restartQuiz").classList.remove("hidden");
        document.getElementById("returnToStart").classList.remove("hidden");
        document.getElementById("progressBarContainer").classList.add("hidden");
        document.getElementById("countdown").classList.add("hidden");
        clearInterval(quizTimer);
        renderMath();
      }

      // Kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u
      if (folders.length === 0) {
        const folderId = crypto.randomUUID();
        folders = [{
          id: folderId,
          name: "To√°n H·ªçc C∆° B·∫£n",
          questions: [
            {
              question: "T√¨m nghi·ªám c·ªßa ph∆∞∆°ng tr√¨nh \\(x^2 - 4 = 0\\)",
              options: ["\\(x = 2, -2\\)", "\\(x = 4, -4\\)", "\\(x = 1, -1\\)", "\\(x = 3, -3\\)"],
              correctOption: "1",
              difficulty: "easy",
              explanation: "Ph∆∞∆°ng tr√¨nh \\(x^2 - 4 = 0\\) ƒë∆∞·ª£c gi·∫£i nh∆∞ sau: \\(x^2 = 4\\), n√™n \\(x = \\pm 2\\)."
            },
            {
              question: "T√≠nh \\(\\int_0^1 x^2 dx\\)",
              options: ["\\(\\frac{1}{3}\\)", "\\(\\frac{1}{2}\\)", "\\(1\\)", "\\(\\frac{2}{3}\\)"],
              correctOption: "1",
              difficulty: "medium",
              explanation: "T√≠ch ph√¢n \\(\\int_0^1 x^2 dx = \\left[\\frac{x^3}{3}\\right]_0^1 = \\frac{1}{3} - 0 = \\frac{1}{3}\\)."
            },
            {
              question: "C√¥ng th·ª©c t√≠nh di·ªán t√≠ch h√¨nh tr√≤n l√† g√¨?",
              options: ["\\(S = \\pi r^2\\)", "\\(S = 2\\pi r\\)", "\\(S = \\pi r\\)", "\\(S = \\frac{1}{2}\\pi r^2\\)"],
              correctOption: "1",
              difficulty: "easy",
              explanation: "Di·ªán t√≠ch h√¨nh tr√≤n ƒë∆∞·ª£c t√≠nh b·∫±ng c√¥ng th·ª©c \\(S = \\pi r^2\\), trong ƒë√≥ \\(r\\) l√† b√°n k√≠nh."
            },
            {
              question: "T√¨m gi√° tr·ªã c·ªßa \\(\\sin(\\frac{\\pi}{2})\\)",
              options: ["1", "0", "\\(\\frac{1}{2}\\)", "-1"],
              correctOption: "1",
              difficulty: "easy",
              explanation: "Theo b·∫£ng gi√° tr·ªã l∆∞·ª£ng gi√°c, \\(\\sin(\\frac{\\pi}{2}) = 1\\)."
            },
            {
              question: "Ph∆∞∆°ng tr√¨nh b·∫≠c hai \\(ax^2 + bx + c = 0\\) c√≥ nghi·ªám khi n√†o?",
              options: ["\\(\\Delta \\geq 0\\)", "\\(\\Delta < 0\\)", "\\(\\Delta = 0\\)", "\\(\\Delta > 0\\)"],
              correctOption: "1",
              difficulty: "hard",
              explanation: "Ph∆∞∆°ng tr√¨nh b·∫≠c hai c√≥ nghi·ªám khi delta \\(\\Delta = b^2 - 4ac \\geq 0\\)."
            }
          ]
        }];
      }

      switchTab("manage");
    </script>
  </div>
</body>
</html>
